
```javascript
import CryptoJS from "crypto-js";
import {JSEncrypt} from "jsencrypt";

export function ewq () {
  let publicKey = `
    -----BEGIN PUBLIC KEY-----
MIIBIjANBgkqhkiG9w0BAQEFAAOCAQ8AMIIBCgKCAQEAvRE+tyVdw+cSSsAldtM9
jFomRKOm2L5Mw4b9u6iUZaiDtULo306wjnWjLeiEkM6aEkcI66Hj4rK7x6MRCryK
xC+LEcoKvxDk22R8zzLIpnJUYY9nkB5FpnAbsxMiNV+wxv0b3HjdBsOqkrd77o8e
dJBv+1VUblNlrxrRMgJvnOvyOMzvMIkj77WR0dxJ4ARHM/lJf1VT1l+cEfF7C8su
XHh6P7u5k8z2tP28BW+2KWGZxi796zFguc0FjMb0arYmKZ6Y6wm2d8dBmERYQk+G
IVtEd+PK9DUoLDfpdbCdJiz3jDV2CX9oxtQBEsp2kefxnFn/DIyqGZU7LRD8lkp8
KwIDAQAB
-----END PUBLIC KEY-----
    `

  let now = new Date().getTime()
  let rand = (Math.floor(Math.random() * 900) + 100).toString()
  const data = now + rand
  const aesKey = CryptoJS.lib.WordArray.random(32).toString(CryptoJS.enc.Hex);
  const iv = CryptoJS.enc.Hex.parse(aesKey.substr(0, 32));
  const encryptedData = CryptoJS.AES.encrypt(data.toString(), CryptoJS.enc.Hex.parse(aesKey), {
    iv,
    mode: CryptoJS.mode.CBC,
    padding: CryptoJS.pad.Pkcs7,
  }).ciphertext.toString(CryptoJS.enc.Base64);
  const encryptor = new JSEncrypt();
  encryptor.setPublicKey(publicKey);
  const encryptedKey = encryptor.encrypt(aesKey); // 输出 base64
  return btoa(JSON.stringify({ key: encryptedKey, data: encryptedData }));
}
```

```php

<?php

declare(strict_types=1);

namespace App\GMTools\Middleware;

use Psr\Container\ContainerExceptionInterface;
use Psr\Container\ContainerInterface;
use Psr\Container\NotFoundExceptionInterface;
use Psr\Http\Message\ResponseInterface;
use Psr\Http\Message\ServerRequestInterface;
use Psr\Http\Server\MiddlewareInterface;
use Psr\Http\Server\RequestHandlerInterface;
use function Hyperf\Support\value;

class CheckRequestMiddleware implements MiddlewareInterface
{
    private string $publicKey = '-----BEGIN PUBLIC KEY-----
MIIBIjANBgkqhkiG9w0BAQEFAAOCAQ8AMIIBCgKCAQEAvRE+tyVdw+cSSsAldtM9
jFomRKOm2L5Mw4b9u6iUZaiDtULo306wjnWjLeiEkM6aEkcI66Hj4rK7x6MRCryK
xC+LEcoKvxDk22R8zzLIpnJUYY9nkB5FpnAbsxMiNV+wxv0b3HjdBsOqkrd77o8e
dJBv+1VUblNlrxrRMgJvnOvyOMzvMIkj77WR0dxJ4ARHM/lJf1VT1l+cEfF7C8su
XHh6P7u5k8z2tP28BW+2KWGZxi796zFguc0FjMb0arYmKZ6Y6wm2d8dBmERYQk+G
IVtEd+PK9DUoLDfpdbCdJiz3jDV2CX9oxtQBEsp2kefxnFn/DIyqGZU7LRD8lkp8
KwIDAQAB
-----END PUBLIC KEY-----
';

    private string $privateKey = '-----BEGIN PRIVATE KEY-----
MIIEvQIBADANBgkqhkiG9w0BAQEFAASCBKcwggSjAgEAAoIBAQC9ET63JV3D5xJK
wCV20z2MWiZEo6bYvkzDhv27qJRlqIO1QujfTrCOdaMt6ISQzpoSRwjroePisrvH
oxEKvIrEL4sRygq/EOTbZHzPMsimclRhj2eQHkWmcBuzEyI1X7DG/RvceN0Gw6qS
t3vujx50kG/7VVRuU2WvGtEyAm+c6/I4zO8wiSPvtZHR3EngBEcz+Ul/VVPWX5wR
8XsLyy5ceHo/u7mTzPa0/bwFb7YpYZnGLv3rMWC5zQWMxvRqtiYpnpjrCbZ3x0GY
RFhCT4YhW0R348r0NSgsN+l1sJ0mLPeMNXYJf2jG1AESynaR5/GcWf8MjKoZlTst
EPyWSnwrAgMBAAECggEAEON+94DaJjCNv5P4D2wMMJgxmJUJHOMBhr/CtOYjUgy3
rdPgaxN44v4wHt7eefRH6qpiFMZSeG110lNHJ5ndnWu6dP2CxebTl/jFy1kNImJ5
FiPnYNt2EPQtDUCAIEYVdkOldFAZkkvygIZCXEt4MXpg07x0vSGBpklzdrpP+l4p
AIhNujkNgW4HasUSYm2XahLrI2sS+hBh/BHc34rNF+baFGnufSicBjir2ailoBtc
YCt+7dWOlsBNcgw5RJzAhpXA/TSY6icDt4am/lHPjFL3kpVUQLQHn+mNkGNRJzia
8o+U1yA5kKT49h2dm5I5TvUMIvWMfap15trq7Xv2hQKBgQD1lKZ3XIxNdYmWBCMc
Fp8/lArwyBhoddEG3qmkzoCgNpu5hss/M76t2aDx05+GcgyQzAbCN3seIY6OfEZa
8xV5kVtNLB0pAt01RvUr1auMdiaLhi3ARGh6COQnFGBDEg3Z5Xkd3usp86dWNFNu
WuaY2jPdI+zZ9fmIsn0dPLTOBQKBgQDFFsf6ovRfmWhjWXCRBgqRSuu8QFe3NYak
znnjSEJ9EAlQZDhdyWc60d8z51Hw/VYi6E56R3PrIwCozHz8OvdzDcf0F3rX3byv
NzVdbo0jwKeVJF5oWp3aeZkJA2F4Xe7Yen6nVF/Xf2qMI0q5a69SmWRc3tIcii9r
ffIGPLEIbwKBgGXTmyqG304G3GOtl3lAEAvmsJqh/SzjHSbCEIlbbo3/1pYYxBGS
vQ+M22UqIE044OjxECRbqNsXguqlsO5pOJBNqxPWpMiqfVpn76SbViRJoTXdDv9X
3hIruZ5Sno9w3vloYs317oBYnRvrWmS5oD/kyfh5uu2tRiheCe6jizyZAoGAE+DS
VrMs1p+QacTRl672TeUylZAfyLi7VdAFdykIm7iMV/FjxgHUSZh1XLTODPJgR7EK
iUa/qE2leWD2kjIYVyBitHnRyAfzSfDVjxDhZ2O9A0vhwcCx/yEYkFIo+Izw1CC2
uYXHDOMrCetdVApKaphSCRPoOTyuv7a6PGrOqD0CgYEAjApmsHBbZVpvFea3FfWf
SINAwvqgO/b5HD5TXrIoImPcRO+qKWAmQg6Mbc2eOweyU8AHiOe3oAdF0DSvfrxM
DaaEFdDlnRCRSRqSZj17xFfb/KWibpSrt8Fwo+DyARVte4vmYv/wvlpYVZn7ywPa
RFmP5+H7DyR/5gPjYryF9J0=
-----END PRIVATE KEY-----';

    public function __construct(protected ContainerInterface $container)
    {
    }

    public function process(ServerRequestInterface $request, RequestHandlerInterface $handler): ResponseInterface
    {
        $header = $request->getHeader('t');
        if (empty($header)) {
            throw new \RuntimeException('No token', 400);
        }

        $payload = json_decode(base64_decode($header[0]), true);
        var_dump($payload);
        if (empty($payload['key']) || empty($payload['data'])) {
            throw new \RuntimeException('Invalid payload', 400);
        }

        // 1️⃣ 用 RSA 私钥解密 AES Key
        $aesKey = '';
        $success = openssl_private_decrypt(base64_decode($payload['key']), $aesKey, $this->privateKey);
        if (!$success) {
            throw new \RuntimeException('Failed to decrypt AES key', 400);
        }

        // 2️⃣ AES key 还原二进制
        $aesKeyBin = hex2bin($aesKey);
        $iv = substr($aesKeyBin, 0, 16);

        // 3️⃣ AES-256-CBC 解密
        $decrypted = openssl_decrypt(
            base64_decode($payload['data']),
            'AES-256-CBC',
            $aesKeyBin,
            OPENSSL_RAW_DATA,
            $iv
        );

        if (!$decrypted) {
            throw new RuntimeException("Failed to decrypt data", 400);
        }
        $second = substr($decrypted, 0, -6);

        if (!$decrypted) {
            throw new \RuntimeException('Invalid decrypted data', 400);
        }

        // 3️⃣ 校验时间戳 ±30分钟
        $now = time();
        $window = 1800;
        if (abs($now - $second) > $window) {
            throw new \RuntimeException('Request expired', 400);
        }

        $this->checkDuplicate((string)$decrypted);

        // 请求通过
        $result = $handler->handle($request);
        return $result;
    }

    private function checkDuplicate(string $data): void
    {
        $redisKey = "gm:request:" . $data;
        $expire = 1800;
        try {
            $redis = redis();
            if (!$redis->set($redisKey, $data, ['nx', 'ex' => $expire])) {
                throw new \RuntimeException('重复请求', 400);
            }
        } catch (NotFoundExceptionInterface|ContainerExceptionInterface $e) {
            throw new \RuntimeException('error4', 400);
        }

    }
}

```